(function(c){WhereIsMyBlock.Form=function(){var f=this,A=c("body"),B=c("div#ccm-dashboard-content > div.container"),k=c("div.ccm-pane-body"),s=c("div.ccm-pane-footer"),g=c("div#ccm-dashboard-content form#wimb"),x=g.find('input[type="submit"]'),m=void 0,t=g.find("select"),l=t.filter('select[name="btid"]'),u=t.filter('select[name="ipp"]'),n=g.find('input[name="sort_by"]'),p=g.find('input[name="sort_dir"]'),v=g.find('input[name="ccm_paging_p"]'),h=g.find('input[name="refresh"]'),C=g.find('input[name="ccm_token"]'),
e={},j=!1,y={},w=[],z=!1,q=!1;this.init=function(){m=c('<div id="ccm-dialog-loader-wrapper" class="ccm-ui"><img id="ccm-dialog-loader" src="'+CCM_IMAGE_PATH+'/throbber_white_32.gif" /></div>');A.append(m);g.on("submit",function(){h.val(1);f.submitForm();return!1});y={edit_collection_popup:!0,versions:!0};w=["ctask=delete","update_metadata=1","update_speed_settings=1","update_permissions=1","update_theme=1"];c(document).ajaxSend(function(a,b,d){if(!d||!d.url)return!1;var r=d.url;a=d.data;var c=/[a-zA-Z0-9\-_\.]+(?=\?)/.exec(r);
b="";if(!c||!c.length)return!1;b=c[0].replace(/(\.[a-zA-Z]+)$/,"");"GET"===d.type&&!0===y[b]&&(z=!0);if(!0===z)if("versions"===b&&"GET"===d.type)-1!==r.indexOf("versions_reloaded=1")&&(q=!0);else if("POST"===d.type){d=0;for(r=w.length;d<r;d++)if(-1!==a.indexOf(w[d])){q=!0;break}}if("sitemap_check_in"===b&&!0===q&&!1===j){var e=k.find("tr.currentRow");d=e.find("td");a=d.css("background-color");e.addClass("highlightRow");d.stop().animate({backgroundColor:a},{duration:800,complete:function(){e.removeClass("currentRow highlightRow");
h.val(1);f.submitForm()}})}});t.each(function(){c(this).on("change",function(){if(l.find(":selected").val().length){var a=c(this).is(l)?1:0;h.val(a);v.val(1);f.submitForm()}})});k.on("click","table#ccm-where-is-my-block th a",function(){if(!1!==j)return!1;var a=n.val(),b=p.val(),d=c(this).attr("data-sort"),b="asc"==b?"desc":"asc";n.val(d);a==d&&p.val(b);h.val(0);f.submitForm()});k.on("click","table#ccm-where-is-my-block tr",function(a){var b=c(this);b.parent().children("tr").removeClass("currentRow highlightRow");
if(!0===j||b.hasClass("ccm-results-list-header"))return!1;var d={cID:b.attr("cID"),select_mode:b.attr("sitemap-select-mode"),display_mode:b.attr("sitemap-display-mode"),instance_id:b.attr("sitemap-instance-id"),isTrash:b.attr("tree-node-istrash"),inTrash:b.attr("tree-node-intrash"),canCompose:b.attr("tree-node-cancompose"),canEditProperties:b.attr("tree-node-can-edit-properties"),canEditSpeedSettings:b.attr("tree-node-can-edit-speed-settings"),canEditPermissions:b.attr("tree-node-can-edit-permissions"),
canEditDesign:b.attr("tree-node-can-edit-design"),canViewVersions:b.attr("tree-node-can-view-versions"),canDelete:b.attr("tree-node-can-delete"),canAddSubpages:b.attr("tree-node-can-add-subpages"),canAddExternalLinks:b.attr("tree-node-can-add-external-links"),cNumChildren:b.attr("cNumChildren"),cAlias:b.attr("cAlias")};b.addClass("currentRow");showPageMenu(d,a)});s.on("click","div.ccm-pagination a",function(){var a=c(this),b=a.parent(),d=/ccm_paging_p=(\d+)/.exec(this.href);if(b.hasClass("disabled")&&
!b.hasClass("ccm-pagination-ellipses")||!1!==j)return!1;d instanceof Array&&d.length?a=parseInt(d[1]):"..."==a.text()?(b=parseInt(a.parent().prev().find("a:first-child").text()),a=parseInt(a.parent().next().find("a:first-child").text()),a=Math.floor((b+a)/2)):a=1;v.val(a);h.val(0);f.submitForm();return!1});""!=l.find(":selected").val()&&(h.val(0),f.submitForm())};this.submitForm=function(){if(!0===j)return!1;f.setFormStatus("busy");var a=c("table#ccm-where-is-my-block");a.length&&a.css({opacity:0.4});
c("div#ccm-dashboard-result-message").remove();k.find(".responseText").remove();e.btid=l.find(":selected").val();e.ipp=u.find(":selected").val();e.sort_by=n.val();e.sort_dir=p.val();e.ccm_paging_p=v.val();e.refresh=h.val();e.ccm_token=C.val();var a="?",b;for(b in e)a+=b+"="+e[b]+"&";a=a.slice(0,a.length-1);c.get(WhereIsMyBlock.URL_TOOL_PAGE_BLOCK_SEARCH+a,f.parseXhrSuccess,"json").error(f.parseXhrError)};this.setFormStatus=function(a){switch(a){case "ready":x.removeAttr("disabled");l.removeAttr("disabled");
u.removeAttr("disabled");m.hide();q=j=!1;break;case "busy":j=!0,x.attr("disabled","disabled"),l.attr("disabled","disabled"),u.attr("disabled","disabled"),m.show()}};this.parseXhrSuccess=function(a){a=a||{};k.find("table.ccm-results-list").remove();k.find("div.ccm-paging-top").remove();s.find("div.ccm-pagination").remove();if("success"===a.status&&a.response&&a.response.tblData&&(a.response.tblData instanceof Array&&a.response.tblData.length)&&"object"===typeof a.response.permInfo){CCM_SEARCH_INSTANCE_ID=
a.response.searchInstance;var b=a.response.tblData,d=a.response.permInfo,c;c='<table border="0" cellspacing="0" cellpadding="0" id="ccm-where-is-my-block" class="ccm-results-list"><thead><tr class="ccm-results-list-header">';for(var e in b[0])if("string"===typeof WhereIsMyBlock.TEXT_TABLE_COLUMNS[e]){var g=n.val()==e?"ccm-results-list-active-sort-"+p.val():"";c+='<th class="'+g+'"><a href="javascript:{};" data-sort="'+e+'">'+WhereIsMyBlock.TEXT_TABLE_COLUMNS[e]+"</a></th>"}c+="</tr></thead><tbody>";
e=0;for(g=b.length;e<g;e++){var h=b[e],j=0!==e%2?" ccm-list-record-alt":"",l=d[h.xPageId].join(" ");c+='<tr class="ccm-list-record'+j+'" '+l+">";for(var m in h)"string"===typeof WhereIsMyBlock.TEXT_TABLE_COLUMNS[m]&&(j=h[m].toString().replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"),c+="<td>"+j+"</td>");c+="</tr>"}c+="</tbody></table>";b=a.response.pgnInfo;a=a.response.pgnHtml;b&&b.length&&(c+='<div class="ccm-paging-top">'+b+"</div>");
a&&a.length&&s.prepend(a);k.prepend(c)}else f.displayMessagesToUser(a);f.setFormStatus("ready")};this.parseXhrError=function(a){var b={status:"error",alert:WhereIsMyBlock.TEXT_AJAX_ERROR,message:WhereIsMyBlock.TEXT_GENERAL_ERROR};a.responseText.length&&(b.alert+=a.responseText.replace(/(<([^>]+)>)/ig,""));f.displayMessagesToUser(b);f.setFormStatus("ready")};this.displayMessagesToUser=function(a){var b;a.alert&&a.alert.length&&(b='<div class="ccm-ui" id="ccm-dashboard-result-message"><div class="row"><div class="span12">'+
('<div class="alert alert-'+a.status+'"><button type="button" class="close" data-dismiss="alert">\u00d7</button>'+a.alert+"</div>"),b+="</div>",b+="</div></div>",b=c(b),b.css("display","block"),B.prepend(b));a.message&&a.message.length&&(a=c('<h5 class="responseText">'+a.message+"</h5>"),k.prepend(a))}}})(jQuery);