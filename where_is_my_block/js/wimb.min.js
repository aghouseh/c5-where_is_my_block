(function(d){WhereIsMyBlock.Form=function(){var f=this,p=d("body"),q=d("div#ccm-dashboard-content > div.container"),g=d("div.ccm-pane-body"),j=d("div.ccm-pane-footer"),c=d("div#ccm-dashboard-content form#wimb"),h=c.find('input[type="submit"]');$loader=void 0;$select=c.find("select");$btidSelect=$select.filter('select[name="btid"]');$ippSelect=$select.filter('select[name="ipp"]');$sortInput=c.find('input[name="sort_by"]');$dirInput=c.find('input[name="sort_dir"]');$pagingInput=c.find('input[name="ccm_paging_p"]');
$refreshInput=c.find('input[name="refresh"]');$tokenInput=c.find('input[name="ccm_token"]');oQueryVars={};bResubmitFormOnCheckIn=bIsAjaxing=!1;this.init=function(){$loader=d('<div id="ccm-dialog-loader-wrapper" class="ccm-ui"><img id="ccm-dialog-loader" src="'+CCM_IMAGE_PATH+'/throbber_white_32.gif" /></div>');p.append($loader);c.on("submit",function(){$refreshInput.val(1);f.submitForm();return!1});d(document).ajaxSend(function(a,b,d){if(!d||!d.url)return!1;a=/[a-zA-Z0-9\-_\.]+(?=\?)/.exec(d.url);
b="";if(!a.length)return!1;b=a[0].replace(/(\.[a-zA-Z]+)$/,"");({edit_collection_popup:!0,versions:!0})[b]&&(bResubmitFormOnCheckIn=!0);"sitemap_check_in"===b&&(!0===bResubmitFormOnCheckIn&&!1===bIsAjaxing)&&($refreshInput.val(1),f.submitForm())});$select.each(function(){d(this).on("change",function(){if($btidSelect.find(":selected").val().length){var a=d(this).is($btidSelect)?1:0;$refreshInput.val(a);$pagingInput.val(1);f.submitForm()}})});g.on("click","table#ccm-where-is-my-block th a",function(){if(!1!==
bIsAjaxing)return!1;var a=$sortInput.val(),b=$dirInput.val(),c=d(this).attr("data-sort"),b="asc"==b?"desc":"asc";$sortInput.val(c);a==c&&$dirInput.val(b);$refreshInput.val(0);f.submitForm()});g.on("click","table#ccm-where-is-my-block tr",function(a){var b=d(this);if(!0===bIsAjaxing||b.hasClass("ccm-results-list-header"))return!1;b={cID:b.attr("cID"),select_mode:b.attr("sitemap-select-mode"),display_mode:b.attr("sitemap-display-mode"),instance_id:b.attr("sitemap-instance-id"),isTrash:b.attr("tree-node-istrash"),
inTrash:b.attr("tree-node-intrash"),canCompose:b.attr("tree-node-cancompose"),canEditProperties:b.attr("tree-node-can-edit-properties"),canEditSpeedSettings:b.attr("tree-node-can-edit-speed-settings"),canEditPermissions:b.attr("tree-node-can-edit-permissions"),canEditDesign:b.attr("tree-node-can-edit-design"),canViewVersions:b.attr("tree-node-can-view-versions"),canDelete:b.attr("tree-node-can-delete"),canAddSubpages:b.attr("tree-node-can-add-subpages"),canAddExternalLinks:b.attr("tree-node-can-add-external-links"),
cNumChildren:b.attr("cNumChildren"),cAlias:b.attr("cAlias")};showPageMenu(b,a)});j.on("click","div.ccm-pagination a",function(){var a=d(this),b=a.parent(),c=/ccm_paging_p=(\d+)/.exec(this.href);if(b.hasClass("disabled")&&!b.hasClass("ccm-pagination-ellipses")||!1!==bIsAjaxing)return!1;c instanceof Array&&c.length?a=parseInt(c[1]):"..."==a.text()?(b=parseInt(a.parent().prev().find("a:first-child").text()),a=parseInt(a.parent().next().find("a:first-child").text()),a=Math.floor((b+a)/2)):a=1;$pagingInput.val(a);
$refreshInput.val(0);f.submitForm();return!1});""!=$btidSelect.find(":selected").val()&&($refreshInput.val(0),f.submitForm())};this.submitForm=function(){if(!0===bIsAjaxing)return!1;f.setFormStatus("busy");var a=d("table#ccm-where-is-my-block");a.length&&a.css({opacity:0.4});d("div#ccm-dashboard-result-message").remove();g.find(".responseText").remove();oQueryVars.btid=$btidSelect.find(":selected").val();oQueryVars.ipp=$ippSelect.find(":selected").val();oQueryVars.sort_by=$sortInput.val();oQueryVars.sort_dir=
$dirInput.val();oQueryVars.ccm_paging_p=$pagingInput.val();oQueryVars.refresh=$refreshInput.val();oQueryVars.ccm_token=$tokenInput.val();var a="?",b;for(b in oQueryVars)a+=b+"="+oQueryVars[b]+"&";a=a.slice(0,a.length-1);d.get(WhereIsMyBlock.URL_TOOL_PAGE_BLOCK_SEARCH+a,f.parseXhrSuccess,"json").error(f.parseXhrError)};this.setFormStatus=function(a){switch(a){case "ready":h.removeAttr("disabled");$btidSelect.removeAttr("disabled");$ippSelect.removeAttr("disabled");$loader.hide();bResubmitFormOnCheckIn=
bIsAjaxing=!1;break;case "busy":bIsAjaxing=!0,h.attr("disabled","disabled"),$btidSelect.attr("disabled","disabled"),$ippSelect.attr("disabled","disabled"),$loader.show()}};this.parseXhrSuccess=function(a){a=a||{};g.find("table.ccm-results-list").remove();g.find("div.ccm-paging-top").remove();j.find("div.ccm-pagination").remove();if("success"===a.status&&a.response&&a.response.tblData&&(a.response.tblData instanceof Array&&a.response.tblData.length)&&"object"===typeof a.response.permInfo){CCM_SEARCH_INSTANCE_ID=
a.response.searchInstance;var b=a.response.tblData,d=a.response.permInfo,e;e='<table border="0" cellspacing="0" cellpadding="0" id="ccm-where-is-my-block" class="ccm-results-list"><thead><tr class="ccm-results-list-header">';for(var c in b[0])if("string"===typeof WhereIsMyBlock.TEXT_TABLE_COLUMNS[c]){var k=$sortInput.val()==c?"ccm-results-list-active-sort-"+$dirInput.val():"";e+='<th class="'+k+'"><a href="javascript:{};" data-sort="'+c+'">'+WhereIsMyBlock.TEXT_TABLE_COLUMNS[c]+"</a></th>"}e+="</tr></thead><tbody>";
c=0;for(k=b.length;c<k;c++){var l=b[c],m=0!==c%2?" ccm-list-record-alt":"",h=d[l.xPageId].join(" ");e+='<tr class="ccm-list-record'+m+'" '+h+">";for(var n in l)"string"===typeof WhereIsMyBlock.TEXT_TABLE_COLUMNS[n]&&(m=l[n].toString().replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"),e+="<td>"+m+"</td>");e+="</tr>"}e+="</tbody></table>";b=a.response.pgnInfo;a=a.response.pgnHtml;b&&b.length&&(e+='<div class="ccm-paging-top">'+b+"</div>");
a&&a.length&&j.prepend(a);g.prepend(e)}else f.displayMessagesToUser(a);f.setFormStatus("ready")};this.parseXhrError=function(a){var b={status:"error",alert:WhereIsMyBlock.TEXT_AJAX_ERROR,message:WhereIsMyBlock.TEXT_GENERAL_ERROR};a.responseText.length&&(b.alert+=a.responseText.replace(/(<([^>]+)>)/ig,""));f.displayMessagesToUser(b);f.setFormStatus("ready")};this.displayMessagesToUser=function(a){var b;a.alert&&a.alert.length&&(b='<div class="ccm-ui" id="ccm-dashboard-result-message"><div class="row"><div class="span12">'+
('<div class="alert alert-'+a.status+'"><button type="button" class="close" data-dismiss="alert">\u00d7</button>'+a.alert+"</div>"),b+="</div>",b+="</div></div>",b=d(b),b.css("display","block"),q.prepend(b));a.message&&a.message.length&&(a=d('<h5 class="responseText">'+a.message+"</h5>"),g.prepend(a))}}})(jQuery);